{% extends 'base.html' %}

{% block content %}
<div style="margin-top: 50px;" class="ui container">
    <h1 class="ui center aligned header">Ваши задачи</h1>
    <div id="messages"></div>

    <form class="ui form" id="add-task-form" onsubmit="return false;" novalidate>
        {% csrf_token %}
        <div class="field">
            <label for="task-name">Название задачи</label>
            <input type="text" id="task-name" name="name" placeholder="Введите название задачи" required>
        </div>
        <button class="ui teal basic button" type="submit">Добавить</button>
    </form>

    <div id="task-list" style="margin-top: 30px;">
        <!-- Задачи будут загружаться через API -->
    </div>
</div>

<script>
    // Глобальная переменная для хранения CSRF токена
    let csrfToken = '';

    // Вспомогательная функция для отправки Fetch-запроса
    async function sendRequest(url, method, data = null) {
        const headers = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        };

        try {
            const response = await fetch(url, {
                method: method,
                headers: headers,
                body: data
            });

            const responseData = await response.json();

            if (!response.ok) {
                return { ...responseData, success: false };
            }

            return { ...responseData, success: true };
        } catch (error) {
            console.error('Ошибка Fetch:', error);
            return {
                success: false,
                message: 'Произошла ошибка при соединении с сервером'
            };
        }
    }

    // Функция для рендеринга статуса задачи
    function renderStatusLabel(status) {
        const statusText = {
            0: 'Не начато',
            1: 'В процессе',
            2: 'Завершено'
        };
        const statusClass = {
            0: 'gray',
            1: 'yellow',
            2: 'green'
        };
        return `<span class="ui ${statusClass[status]} label">${statusText[status]}</span>`;
    }

    // Функция для рендеринга кнопок управления задачей
    function renderTaskButtons(taskId, status) {
        let buttons = '';

        if (status === 0) {
            buttons = `<button type="button" class="ui green basic button" onclick="updateTaskStatus(${taskId}, 1)">Начать</button>`;
        } else if (status === 1) {
            buttons = `
                <button type="button" class="ui orange basic button" onclick="updateTaskStatus(${taskId}, 0)">Отменить</button>
                <button type="button" class="ui green basic button" onclick="updateTaskStatus(${taskId}, 2)">Завершить</button>
            `;
        } else {
            buttons = `<button type="button" class="ui orange basic button" onclick="updateTaskStatus(${taskId}, 1)">Вернуть</button>`;
        }

        buttons += `<button type="button" class="ui negative basic button" onclick="deleteTask(${taskId})">Удалить</button>`;
        return buttons;
    }

    // Функция для рендеринга задачи
    function renderTask(task) {
        return `
        <div class="ui segment" data-task-id="${task.id}">
            <p class="ui big header">${task.name}</p>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                ${renderStatusLabel(task.is_completed)}
                ${renderTaskButtons(task.id, task.is_completed)}
            </div>
        </div>
        `;
    }

    // Функция для загрузки задач
    async function loadTasks() {
        const response = await sendRequest('/api/v1/tasks/', 'GET');
        if (response.success) {
            // Сохраняем CSRF токен при первой загрузке
            if (response.csrf_token) {
                csrfToken = response.csrf_token;
            }
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            response.tasks.forEach(task => {
                taskList.insertAdjacentHTML('beforeend', renderTask(task));
            });
        } else {
            showMessage(response.message || 'Не удалось загрузить задачи', 'error');
        }
    }

    // Функция для отображения сообщений
    function showMessage(message, type = 'success') {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = `<div class="ui ${type} message"><p>${message}</p></div>`;
        setTimeout(() => {
            messagesDiv.innerHTML = '';
        }, 5000);
    }

    // Функция для добавления задачи
    async function addTask(name) {
        const data = JSON.stringify({ name: name });
        const response = await sendRequest('/api/v1/tasks/', 'POST', data);

        if (response.success) {
            const taskList = document.getElementById('task-list');
            taskList.insertAdjacentHTML('afterbegin', renderTask(response.data));
            showMessage(response.message);
            document.getElementById('add-task-form').reset();
        } else {
            showMessage(response.message, 'error');
        }
    }

    // Функция для обновления статуса задачи
    async function updateTaskStatus(taskId, newStatus) {
        const currentStatusElement = document.querySelector(`div[data-task-id="${taskId}"] span.ui.label`);
        const currentStatus = currentStatusElement.textContent.trim() === 'Не начато' ? 0 :
                             currentStatusElement.textContent.trim() === 'В процессе' ? 1 : 2;

        const change = newStatus - currentStatus;
        const data = JSON.stringify({ change: change });
        const response = await sendRequest(`/api/v1/tasks/${taskId}/`, 'PATCH', data);

        if (response.success) {
            const taskElement = document.querySelector(`div[data-task-id="${taskId}"]`);
            taskElement.outerHTML = renderTask(response.data);
            showMessage(response.message);
        } else {
            showMessage(response.message, 'error');
        }
    }

    // Функция для удаления задачи
    async function deleteTask(taskId) {
        const response = await sendRequest(`/api/v1/tasks/${taskId}/`, 'DELETE');

        if (response.success) {
            document.querySelector(`div[data-task-id="${taskId}"]`).remove();
            showMessage(response.message);
        } else {
            showMessage(response.message, 'error');
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();

        document.getElementById('add-task-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = this.querySelector('input[name="name"]').value.trim();
            addTask(name);
        });
    });
</script>
{% endblock %}